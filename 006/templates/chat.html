<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>D365 Plugin Copilot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    pre code { white-space: pre; }
    .copy-btn {
      position: absolute; top: 1.25rem; right: 1.25rem;
    }
  </style>
  <script>
    function copyCode() {
      const code = document.getElementById('generated-code-block').innerText;
      navigator.clipboard.writeText(code);
      const btn = document.getElementById('copy-btn');
      btn.textContent = "Copied!";
      setTimeout(() => { btn.textContent = "Copy code"; }, 1500);
    }
  </script>
</head>
<body class="bg-slate-100 text-gray-900 min-h-screen">
  <div class="w-full px-2 md:px-6 lg:px-12 mt-8 flex flex-col md:flex-row gap-4 md:gap-8">
    <!-- Chat/progress panel (left) -->
    <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6 flex flex-col w-full md:w-1/3">
      <h1 class="text-2xl font-bold mb-2 text-blue-800">Dynamics 365 Plugin Copilot</h1>
      <div class="mb-4 text-base text-gray-700">
        ðŸ‘‹ <b>Welcome to Dynamics 365 Plugin Copilot!</b><br>
        Tell me what business logic you want to automate in Dynamics 365, and I'll guide you to generate the perfect C# plugin step by step.
      </div>
      <div class="bg-gray-50 rounded p-3 mb-4 border">
        <div class="prose-sm">
          {{ progress_md | safe }}
        </div>
      </div>
      <form method="post" class="mb-2 flex flex-col gap-3">
        {% if not confirmed %}
          <input type="text" name="user_input" class="border rounded px-3 py-2 w-full focus:outline-blue-300" autofocus autocomplete="off" placeholder="Type your answer..." />
        {% endif %}
        <div class="prose max-w-none mb-2">
          {{ reply|safe if not confirmed }}
        </div>
        <div class="flex flex-row gap-2">
          {% if not confirmed %}
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send</button>
          {% endif %}
          {% if all_ready and not confirmed %}
            <button type="submit" name="confirm" value="1" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
              Confirm &amp; Generate Code
            </button>
          {% endif %}
          <button type="submit" name="restart" value="1" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">
            Restart
          </button>
        </div>
      </form>

      {% if confirmed %}
        <div class="mt-8">
          <div class="text-lg font-medium mb-2">Want to improve or regenerate the code?</div>
          <input id="new-logic-input" type="text" class="border rounded px-3 py-2 w-full mb-2" placeholder="E.g. Add a check for email field too..." autocomplete="off" />
          <div class="flex flex-row gap-2">
            <button onclick="regeneratePlugin()" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800">Regenerate Plugin</button>
            <form method="post">
              <button type="submit" name="restart" value="1" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Start Over</button>
            </form>
          </div>
        </div>
        <script>
          function regeneratePlugin() {
            const newLogic = document.getElementById("new-logic-input").value;
            fetch("/regenerate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ new_logic: newLogic })
            })
            .then(res => res.json())
            .then(data => {
              if (data.code) {
                document.getElementById("generated-code-block").innerText = data.code;
              } else {
                alert("Error: " + (data.error || "Unable to regenerate."));
              }
            });
          }
        </script>
      {% endif %}
    </div>

    <!-- Code panel (right) -->
    {% if confirmed %}
    <div class="relative bg-slate-50 rounded-2xl shadow-xl p-4 md:p-6 border border-green-200 overflow-x-auto w-full md:w-2/3">
      <h2 class="text-xl font-semibold mb-3 text-green-700 flex items-center">Generated C# Plugin Code</h2>
      <button id="copy-btn" type="button" class="copy-btn bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs" onclick="copyCode()">Copy code</button>
      <div class="prose max-w-none mt-4">
        <pre class="rounded-xl bg-gray-900 text-green-100 text-sm p-4 overflow-x-auto"><code id="generated-code-block">{{ reply|safe }}</code></pre>
      </div>
    </div>
    {% endif %}
  </div>
</body>
</html>
